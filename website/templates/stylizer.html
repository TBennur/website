<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Tanay Bennur: Stylizer</title>

    <link rel="stylesheet" type="text/css" href="{{ url_for('static',     filename='css/stylizerOverrides.css') }}">
  </head>
  <body>
    {% extends "template.html" %}
    {% block content %}
    
    <script type=text/javascript>
        
        // Addresses for default images
        images_address = {
            1 : "{{ url_for('static',     filename='defaultFiles/Images/beach.jpg') }}", 
            2 : "{{ url_for('static',     filename='defaultFiles/Images/cave.png') }}",
            3 : "{{ url_for('static',     filename='defaultFiles/Images/foggy.jpg') }}",
            4 : "{{ url_for('static',     filename='defaultFiles/Images/lake.jpg') }}",
            5 : "{{ url_for('static',     filename='defaultFiles/Images/microscope.jpg') }}",
            6 : "{{ url_for('static',     filename='defaultFiles/Images/mountain.png') }}",
            7 : "{{ url_for('static',     filename='defaultFiles/Images/pittsburgh.jpg') }}",
            8 : "{{ url_for('static',     filename='defaultFiles/Images/sunset.jpg') }}",
            9 : "{{ url_for('static',     filename='defaultFiles/Images/train.jpg') }}",
            10 : "{{ url_for('static',     filename='defaultFiles/Images/wasteland.jpg') }}"
        }

        images_naming = {
            1 : "Beach",
            2 : "Cave",
            3 : "Foggy",
            4 : "Lake",
            5 : "Microscope",
            6 : "Mountain",
            7 : "Pittsburgh",
            8 : "Sunset",
            9 : "Train",
            10 : "Wasteland"
        }

        // Palette size hierarchy
        palettes = {
            "Small" : ["Carpet Rose", "Monometalic", "Stormy"], 
            "8-Color" : ["Ammo", "Dawnbringers", "Dreamscape", "Just Parchment", "Paper", "Rust Gold"],
            "16-Color" : ["Dawnbringer", "Endesgas", "Feel The Sun", "Galaxy Flame", "Lost Century", "Ramp Rainbow", "Steam Lords"],
            "32-Color" : ["AFR", "Endesga", "Fantasy", "Hept", "Marshmellow", "Nanner"],
            "Large" : ["Comicscapes", "Resurrect", "Shido"]
        }

        // Status variables
        var palette_selected = false;     
        var current_palette = null; 
        var current_image = "Beach";
        var image_custom = false;

        // Main function, runs on stylize button press
        async function stylize() {
            
            if (palette_selected) {
                var image = document.getElementById("styled-image");
                var error_text = document.getElementById("file-error");
                fetch("{{ url_for('stylize_button') }}", 
                    {method: "POST", 
                    headers: {'content-type': 'application/json'},
                    body: JSON.stringify(current_image + "|" + current_palette + "|" + image_custom)})
                .then(response => response.json())
                .then(data => {
                    if (data.Status == "Success") {
                        image.src = "data:image/png;base64," + data.ImageBytes;
                    }
                    else {
                        error_text.hidden = false;
                        error_text.innerHTML = data.Reason;
                    }
                });
            }; 
        
        }
        
        // Updates selected image
        function select_image() {
            
            var selected_image_num = Math.floor(Math.random() * 10) + 1
            var selected_image_name = images_naming[selected_image_num]
            var image = document.getElementById("unstyled-image");

            while (selected_image_name == current_image) {
                selected_image_num = Math.floor(Math.random() * 10) + 1
                selected_image_name = images_naming[selected_image_num]
            }

            image.src = images_address[selected_image_num];
            current_image = selected_image_name;
            image_custom = false;

        }

        // Updates cascading dropdown
        function generate_secondary_dropdown() {
            
            var palette_primary = document.getElementById("palette-primary");
            var palette_size = palette_primary.value;
            var palette_secondary = document.getElementById("palette-secondary");
            var palette_image = document.getElementById("palette-image");

            if (palette_size == "Please Select a Palette Size") {
                palette_secondary.style.display = "none";        
                palette_image.style.visibility = "hidden";        
                palette_selected = false;
                current_palette = null;
            }
            else {
                palette_secondary.style.display = "block";
                palette_image.style.visiblity = "hidden";
            }

            palette_secondary.length = 1;

            for (var y in palettes[palette_size]) {
                palette_secondary.options[palette_secondary.options.length] = new Option(palettes[palette_size][y], palettes[palette_size][y]);
            }

        }

        // Updates palette selection
        function select_palette() {
            
            var palette_primary = document.getElementById("palette-primary");
            var palette_size = palette_primary.value;
            var palette_secondary = document.getElementById("palette-secondary");
            var palette_image = document.getElementById("palette-image");

            if (palette_secondary.value == "Please Select a palette") {
                palette_selected = false;
                current_palette = null;
                palette_image.style.visibility = "hidden";        
            }
            else {
                palette_secondary.style.display = "block";
                palette_selected = true;
                current_palette = palette_secondary.value; 
                palette_image.style.visibility = "visible";
                fetch("{{ url_for('visualize_palette') }}", 
                    {method: "POST", 
                    headers: {'content-type': 'application/json'},
                    body: JSON.stringify(current_palette)})
                .then(response => response.json())
                .then(data => {
                    palette_image.src = "data:image/png;base64," + data.ImageBytes;
                });            
            }

            }

        async function upload() {
            var upload_button = document.getElementById("image-upload");
            var source_image = document.getElementById("unstyled-image");
            var error_text = document.getElementById("file-error");
            var file = upload_button.files[0];
            const formData = new FormData();

            formData.append("file", file)

            fetch("{{ url_for('visualize_image') }}", 
                {method: "POST", 
                files: file,
                body: formData})
            .then(response => response.json())
            .then(data => {
                if (data.Status == "Success") {
                    source_image.src = "data:image/png;base64," + data.ImageBytes;
                    current_image = file.name;
                    image_custom = true;
                    error_text.hidden = true;
                }
                else {
                    error_text.hidden = false;
                    error_text.innerHTML = data.Reason;
                }
            });
        }
        

    </script>

    <div class="container-fluid webpage-render">
        <div class="container-fluid">
            <div class="row">
                <div class = "col-xxl-5">
                    <h3 class = "text-center"> Starting Image </h3>
                </div>
                <div class = "col-xxl-2">
                    <h3 class = "text-center"> Palette </h3>
                </div>
                <div class = "col-xxl-5">
                    <h3 class = "text-center"> Stylized Image </h3>
                </div>
            </div>
            
            <div class="row">
                
                <div class = "col-xxl-5">
                    
                    <div class='container align-top stylizer-image text-center'>
                        <img id = "unstyled-image" src="{{ url_for('static',     filename='defaultFiles/Images/beach.jpg') }}" class="img-fluid stylized-image center">
                    </div>

                    <div class='container text-center'>
                        <form>
                            <button onclick="select_image()" class='btn btn-primary selection-button' type="button">Random Image!</button>
                            
                            <label class = "upload-primary selection-button">
                                <input type = "file" name = "file" id = "image-upload" onchange = "upload()">
                                Upload File
                            </label>
                        </form>
                    </div>

                    <p id = "file-error" class = "text-center" hidden></p>

                </div>

                <div class="col-xxl-2">
                    <div class='container-fluid align-top d-flex justify-content-center'>
                        <form>
                            <select onchange="generate_secondary_dropdown()" id="palette-primary" class="form-select-sm primary-palette" aria-label="Default select example">
                                <option selected>Please Select a Palette Size</option>
                                <option value="Small">Small</option>
                                <option value="8-Color">8-Color</option>
                                <option value="16-Color">16-Color</option>
                                <option value="32-Color">32-Color</option>
                                <option value="Large">Large</option>
                            </select>
                            <select onchange="select_palette()" id="palette-secondary" class="form-select-sm secondary-palette" aria-label="Default select example">
                                <option selected>Please Select a palette</option>
                            </select>
                        </form>
                    </div>
                
                    <div class='container align-top stylize-button position-relative text-center'>
                        <form>
                            <button onclick="stylize()" class='btn btn-primary' type="button">Stylize!</button>
                        </form>
                    </div>

                    <div class='container-fluid align-top palette-image text-center'>
                        <img id = "palette-image" class="img-fluid styled-image center">
                    </div>
                </div>

                <div class = "col-xxl-5">
                    <div class='container align-top stylizer-image text-center'>
                        <img id = "styled-image" src="{{ url_for('static',     filename='defaultFiles/Images/beach.jpg') }}" class="img-fluid styled-image center">
                    </div>
                </div>
                
            </div>

            <div class="row stylizer-bottom-text">
                <p class = "text-center"> This tool allows you to render pictures in small color palettes reminiscent of 8-bit games. These palettes can be found online at 
                    <a href = "https://lospec.com/palette-list" class = "text-dark" style = "text-decoration: none"> 
                        https://lospec.com/palette-list.
                    </a>
                </p>
            </div>

        </div>
    </div>

    {% endblock %}
  </body>
</html>
